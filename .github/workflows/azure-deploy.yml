name: Deploy to Azure (Front Door + Blob Storage + Functions)

on:
  push:
    branches: [main]
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches: [main]

env:
  NODE_VERSION: '20'
  # â”€â”€ Production â”€â”€
  AZURE_STORAGE_ACCOUNT_PROD: stportalinfinityprod001
  AZURE_CDN_PROFILE: afd-portal-prod
  AZURE_CDN_ENDPOINT_PROD: infinity-frontend
  AZURE_RESOURCE_GROUP: rg-portal-app-prod
  AZURE_FUNCTIONAPP_NAME_PROD: infinity-portal-app-prod-001
  # â”€â”€ Staging â”€â”€
  AZURE_STORAGE_ACCOUNT_STAGING: stportalinfinitystaging
  AZURE_CDN_ENDPOINT_STAGING: infinity-frontend-staging
  AZURE_FUNCTIONAPP_NAME_STAGING: infinity-portal-app-staging-001

jobs:
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # PRODUCTION â€” triggers on push to main
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  deploy_frontend_prod:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    name: ðŸš€ Deploy Frontend (Production)
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Build frontend
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          VITE_AZURE_AD_TENANT: ${{ secrets.VITE_AZURE_AD_TENANT }}
          VITE_AZURE_AD_CLIENT_ID: ${{ secrets.VITE_AZURE_AD_CLIENT_ID }}
          VITE_AZURE_STORAGE_URL: ${{ secrets.VITE_AZURE_STORAGE_URL }}
          VITE_APPINSIGHTS_CONNECTION_STRING: ${{ secrets.VITE_APPINSIGHTS_CONNECTION_STRING }}
          VITE_AZURE_SEARCH_URL: ${{ secrets.VITE_AZURE_SEARCH_URL }}
          VITE_AZURE_SEARCH_KEY: ${{ secrets.VITE_AZURE_SEARCH_KEY }}
        run: npm run build

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Upload to Blob Storage ($web)
        uses: azure/cli@v2
        with:
          inlineScript: |
            az storage blob upload-batch \
              --account-name ${{ env.AZURE_STORAGE_ACCOUNT_PROD }} \
              --destination '$web' \
              --source ./dist \
              --overwrite true \
              --content-cache-control "public, max-age=31536000, immutable" \
              --pattern "assets/*"

            az storage blob upload-batch \
              --account-name ${{ env.AZURE_STORAGE_ACCOUNT_PROD }} \
              --destination '$web' \
              --source ./dist \
              --overwrite true \
              --content-cache-control "no-cache" \
              --pattern "*.html"

            az storage blob upload-batch \
              --account-name ${{ env.AZURE_STORAGE_ACCOUNT_PROD }} \
              --destination '$web' \
              --source ./dist \
              --overwrite true \
              --content-cache-control "no-cache" \
              --pattern "*.json"

      - name: Purge Front Door cache
        uses: azure/cli@v2
        with:
          inlineScript: |
            az afd endpoint purge \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --profile-name ${{ env.AZURE_CDN_PROFILE }} \
              --endpoint-name ${{ env.AZURE_CDN_ENDPOINT_PROD }} \
              --content-paths "/*"

  deploy_functions_prod:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    name: ðŸš€ Deploy Functions (Production)
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install & build Functions
        working-directory: azure-functions
        run: |
          npm ci
          npm run build

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Azure Functions
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME_PROD }}
          package: azure-functions
          respect-funcignore: true

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # STAGING â€” triggers on PR open/update
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  deploy_frontend_staging:
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    name: ðŸ§ª Deploy Frontend (Staging)
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install dependencies
        run: npm ci

      - name: Build frontend (staging)
        env:
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL_STAGING }}
          VITE_AZURE_AD_TENANT: ${{ secrets.VITE_AZURE_AD_TENANT }}
          VITE_AZURE_AD_CLIENT_ID: ${{ secrets.VITE_AZURE_AD_CLIENT_ID }}
          VITE_AZURE_STORAGE_URL: ${{ secrets.VITE_AZURE_STORAGE_URL_STAGING }}
          VITE_APPINSIGHTS_CONNECTION_STRING: ${{ secrets.VITE_APPINSIGHTS_CONNECTION_STRING }}
          VITE_AZURE_SEARCH_URL: ${{ secrets.VITE_AZURE_SEARCH_URL }}
          VITE_AZURE_SEARCH_KEY: ${{ secrets.VITE_AZURE_SEARCH_KEY }}
        run: npm run build

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Create staging container (PR-specific)
        uses: azure/cli@v2
        with:
          inlineScript: |
            # Upload to a PR-specific path inside $web so multiple PRs don't collide
            PR_NUMBER=${{ github.event.pull_request.number }}

            az storage blob upload-batch \
              --account-name ${{ env.AZURE_STORAGE_ACCOUNT_STAGING }} \
              --destination '$web' \
              --destination-path "pr-${PR_NUMBER}" \
              --source ./dist \
              --overwrite true

      - name: Purge staging Front Door cache
        uses: azure/cli@v2
        with:
          inlineScript: |
            az afd endpoint purge \
              --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
              --profile-name ${{ env.AZURE_CDN_PROFILE }} \
              --endpoint-name ${{ env.AZURE_CDN_ENDPOINT_STAGING }} \
              --content-paths "/pr-${{ github.event.pull_request.number }}/*"

      - name: Comment PR with staging URL
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = context.payload.pull_request.number;
            const stagingUrl = `https://${{ env.AZURE_CDN_ENDPOINT_STAGING }}.azurefd.net/pr-${prNumber}/`;
            const body = `## ðŸ§ª Staging Preview\n\nFrontend deployed to staging:\nðŸ‘‰ **[${stagingUrl}](${stagingUrl})**\n\n_Auto-deployed by GitHub Actions. Will be cleaned up when PR is closed._`;

            // Check if we already commented
            const { data: comments } = await github.rest.issues.listComments({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
            });
            const existing = comments.find(c => c.body?.includes('Staging Preview'));

            if (existing) {
              await github.rest.issues.updateComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                comment_id: existing.id,
                body,
              });
            } else {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: prNumber,
                body,
              });
            }

  deploy_functions_staging:
    if: github.event_name == 'pull_request' && github.event.action != 'closed'
    runs-on: ubuntu-latest
    name: ðŸ§ª Deploy Functions (Staging Slot)
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Install & build Functions
        working-directory: azure-functions
        run: |
          npm ci
          npm run build

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to staging slot
        uses: Azure/functions-action@v1
        with:
          app-name: ${{ env.AZURE_FUNCTIONAPP_NAME_STAGING }}
          package: azure-functions
          respect-funcignore: true
          slot-name: staging

  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”
  # CLEANUP â€” triggers on PR close/merge
  # â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”

  cleanup_staging:
    if: github.event_name == 'pull_request' && github.event.action == 'closed'
    runs-on: ubuntu-latest
    name: ðŸ§¹ Cleanup Staging
    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Delete PR staging files
        uses: azure/cli@v2
        with:
          inlineScript: |
            PR_NUMBER=${{ github.event.pull_request.number }}

            # Delete all blobs under the PR path
            az storage blob delete-batch \
              --account-name ${{ env.AZURE_STORAGE_ACCOUNT_STAGING }} \
              --source '$web' \
              --pattern "pr-${PR_NUMBER}/*" \
              2>/dev/null || echo "No staging files to clean up"

            echo "âœ… Cleaned up staging for PR #${PR_NUMBER}"
