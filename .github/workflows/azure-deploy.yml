name: Deploy to Azure App Service (Frontend + API)

on:
  push:
    branches: [main]

env:
  NODE_VERSION: '20'
  AZURE_CLIENT_ID: 02f4f574-35df-4a2e-9a9b-99cac22aa223
  AZURE_TENANT_ID: c3fe8cd9-f644-4f76-bb09-920687b1237d
  AZURE_SUBSCRIPTION_ID: e2dde12e-087a-4db9-80cc-129d6dbec90b
  AZURE_NETWORK_RESOURCE_GROUP: rg-portal-network
  AZURE_CDN_PROFILE: afd-portal-prod
  AZURE_CDN_ENDPOINT_PROD: infinity-frontend
  AZURE_APP_RESOURCE_GROUP: rg-portal-app-prod
  AZURE_WEBAPP_NAME_PROD: infinity-portal-app-prod-001

permissions:
  id-token: write
  contents: read
  pull-requests: write

jobs:
  deploy_app_prod:
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    name: üöÄ Deploy App Service (Production)
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      - name: Build frontend
        env:
          VITE_API_BASE_URL: https://infinitybd.live/api
          VITE_AZURE_AD_TENANT: ${{ secrets.VITE_AZURE_AD_TENANT }}
          VITE_AZURE_AD_CLIENT_ID: ${{ secrets.VITE_AZURE_AD_CLIENT_ID }}
          VITE_AZURE_STORAGE_URL: ${{ secrets.VITE_AZURE_STORAGE_URL }}
          VITE_APPINSIGHTS_CONNECTION_STRING: ${{ secrets.VITE_APPINSIGHTS_CONNECTION_STRING }}
          VITE_AZURE_SEARCH_URL: ${{ secrets.VITE_AZURE_SEARCH_URL }}
          VITE_AZURE_SEARCH_KEY: ${{ secrets.VITE_AZURE_SEARCH_KEY }}
          VITE_ADMIN_API_TOKEN: ${{ secrets.ADMIN_API_TOKEN }}
        run: |
          npm ci
          npm run build

      - name: Build App Service API package
        run: |
          cd app-service-api
          npm ci
          npm run build
          mkdir -p dist/public
          cp -r ../dist/* dist/public/
          npm prune --omit=dev

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Configure App Service settings
        uses: azure/cli@v2
        with:
          inlineScript: |
            az webapp config appsettings set \
              --resource-group ${{ env.AZURE_APP_RESOURCE_GROUP }} \
              --name ${{ env.AZURE_WEBAPP_NAME_PROD }} \
              --settings \
                AUTH_JWT_SECRET='${{ secrets.AUTH_JWT_SECRET }}' \
                ADMIN_API_TOKEN='${{ secrets.ADMIN_API_TOKEN }}' \
                DB_CONNECTION_STRING='${{ secrets.DB_CONNECTION_STRING }}' \
                AZURE_STORAGE_CONNECTION_STRING='${{ secrets.AZURE_STORAGE_CONNECTION_STRING }}' \
                AZURE_STORAGE_ACCOUNT='${{ secrets.AZURE_STORAGE_ACCOUNT }}' \
                CMS_BLOB_CONTAINER='${{ secrets.CMS_BLOB_CONTAINER }}' \
                KEY_VAULT_URL='${{ secrets.KEY_VAULT_URL }}'

      - name: Apply SQL schema updates
        env:
          DB_CONNECTION_STRING: ${{ secrets.DB_CONNECTION_STRING }}
        run: |
          if [ -z "$DB_CONNECTION_STRING" ]; then
            echo "DB_CONNECTION_STRING GitHub secret is missing" >&2
            exit 1
          fi
          cd app-service-api
          node scripts/apply-cms-schema.cjs

      - name: Deploy to App Service (Production)
        uses: azure/webapps-deploy@v3
        with:
          app-name: ${{ env.AZURE_WEBAPP_NAME_PROD }}
          package: app-service-api

      - name: Purge Front Door cache
        uses: azure/cli@v2
        with:
          inlineScript: |
            az afd endpoint purge \
              --resource-group ${{ env.AZURE_NETWORK_RESOURCE_GROUP }} \
              --profile-name ${{ env.AZURE_CDN_PROFILE }} \
              --endpoint-name ${{ env.AZURE_CDN_ENDPOINT_PROD }} \
              --content-paths "/*"

  smoke_test_prod:
    if: github.event_name == 'push'
    needs: [deploy_app_prod]
    runs-on: ubuntu-latest
    name: üîé Smoke Test (Production)
    steps:
      - name: Validate homepage
        run: |
          for i in {1..10}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://infinitybd.live/)
            if [ "$STATUS" -ge 200 ] && [ "$STATUS" -lt 400 ]; then
              echo "Homepage check passed with status $STATUS"
              exit 0
            fi
            echo "Homepage check failed with status $STATUS, retry $i/10"
            sleep 10
          done
          exit 1

      - name: Validate products API
        run: |
          for i in {1..10}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://infinitybd.live/api/products)
            if [ "$STATUS" -ge 200 ] && [ "$STATUS" -lt 400 ]; then
              echo "Products API check passed with status $STATUS"
              exit 0
            fi
            echo "Products API check failed with status $STATUS, retry $i/10"
            sleep 10
          done
          exit 1

      - name: Validate auth API route
        run: |
          for i in {1..10}; do
            STATUS=$(curl -s -o /dev/null -w "%{http_code}" https://infinitybd.live/api/auth/me)
            if [ "$STATUS" = "401" ] || [ "$STATUS" = "200" ]; then
              echo "Auth API route check passed with status $STATUS"
              exit 0
            fi
            echo "Auth API route check failed with status $STATUS, retry $i/10"
            sleep 10
          done
          exit 1

  rollback_app_prod:
    if: github.event_name == 'push' && needs.smoke_test_prod.result == 'failure'
    needs: [smoke_test_prod]
    runs-on: ubuntu-latest
    name: ‚ôªÔ∏è Rollback App Service (Production)
    steps:
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ env.AZURE_CLIENT_ID }}
          tenant-id: ${{ env.AZURE_TENANT_ID }}
          subscription-id: ${{ env.AZURE_SUBSCRIPTION_ID }}

      - name: Swap staging slot to production
        uses: azure/cli@v2
        with:
          inlineScript: |
            SLOT_EXISTS=$(az webapp deployment slot list \
              --resource-group ${{ env.AZURE_APP_RESOURCE_GROUP }} \
              --name ${{ env.AZURE_WEBAPP_NAME_PROD }} \
              --query "[?name=='staging'] | length(@)" \
              -o tsv)

            if [ "$SLOT_EXISTS" = "1" ]; then
              az webapp deployment slot swap \
                --resource-group ${{ env.AZURE_APP_RESOURCE_GROUP }} \
                --name ${{ env.AZURE_WEBAPP_NAME_PROD }} \
                --slot staging \
                --target-slot production
              echo "Rolled back production app using staging slot"
            else
              echo "No staging slot found; rollback skipped (non-blocking)"
              exit 0
            fi
